name: {{FRAMEWORK_NAME}}
web-url: http://proxylite-0-server.{{FRAMEWORK_NAME}}.mesos:4040
pods:
  couchbase_data:
    placement: couchbase-eligible:CLUSTER:true
    uris: 
      - {{COUCHBASE_INSTALLER_LOCATION}}
      - https://s3-us-west-2.amazonaws.com/jharper-public-mesosphere/samples/beer-sample.zip
      - https://s3-us-west-2.amazonaws.com/jharper-public-mesosphere/samples/travel-sample.zip
      - https://s3-us-west-2.amazonaws.com/jharper-public-mesosphere/samples/gamesim-sample.zip
    count: {{DATA_SERVICE_COUNT}}
    resource-sets:
      couchbase-resources:
        cpus: {{DATA_SERVICE_CPUS}}
        memory: {{DATA_SERVICE_MEM}}
        volume:
          path: couchbase-container-path
          type: ROOT
          size: {{DATA_SERVICE_DISK}}
        ports:
          couchbase-web-console:
            port: 8091
          design-doc:
            port: 8092
          query-rest:
            port: 8093
          search-rest:
            port: 8094
          internal-index-admin:
            port: 9100
          internal-index-scan:
            port: 9101
          internal-index-http:
            port: 9102
          internal-index-build:
            port: 9103
          internal-index-build-catchup:
            port: 9104
          internal-index-maintenance:
            port: 9105
          internal-rest:
            port: 9998
          internal-gsi:
            port: 9999
          smart-client-data:
            port: 11207
          internal-bucket:
            port: 11209
          smart-client-memcached:
            port: 11210
          legacy-memcached:
            port: 11211
          xdcr-ssl-1:
            port: 11214
          xdcr-ssl-2:
            port: 11215
          couchbase-web-console-ssl:
            port: 18091
          design-doc-ssl:
            port: 18092
          query-ssl:
            port: 18093
          erlang-port-mapper:
            port: 4369                                                                                                                                                               
      cli-resources:
        cpus: 1
        memory: 1024     
    container:
      image-name: centos
      rlimits:
        RLIMIT_NOFILE:
          soft: 40960
          hard: 40960
        RLIMIT_CORE:
          soft: 15728640
          hard: 15728640  
    tasks:
      server:
        goal: RUNNING
        resource-set: couchbase-resources
        cmd: >
          cd $MESOS_SANDBOX/couchbase-container-path &&
          mkdir -p var/lib/couchbase var/lib/couchbase/crash var/lib/couchbase/config var/lib/couchbase/stats var/lib/couchbase/index var/lib/couchbase/logs var/lib/couchbase/data var/lib/moxi &&
          cd .. &&
          yum -y install openssl &&
          rpm -i couchbase-server-enterprise-4.5.1-centos7.x86_64.rpm &&
          chown -R couchbase:couchbase $MESOS_SANDBOX/couchbase-container-path/var &&
          cd /opt/couchbase/var/lib/couchbase &&
          rm -rf config/ stats/ logs/ crash/ data/ &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/config config &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/logs logs &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/stats stats &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/data data &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/index index &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/crash crash &&
          cd .. &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/moxi moxi &&
          /opt/couchbase/bin/couchbase-server -- -noinput
        readiness-check:
          cmd: curl -I localhost:8091/ui/index.html | grep "HTTP/1.1 200 OK"
          interval: 5
          delay: 0
          timeout: 10
      add-data-node:
        goal: FINISHED
        cmd: >
          /opt/couchbase/bin/couchbase-cli server-add -c couchbase-data-0-server.{{FRAMEWORK_NAME}}.mesos:8091 -u Administrator -p {{COUCHBASE_ADMIN_PASSWORD}} --server-add=couchbase-data-$POD_INSTANCE_INDEX-server.{{FRAMEWORK_NAME}}.mesos:8091 --server-add-username=Administrator --server-add-password={{COUCHBASE_ADMIN_PASSWORD}} --services=data
        resource-set: cli-resources
      initialize-cluster:
        goal: FINISHED
        cmd: >
             /opt/couchbase/bin/couchbase-cli cluster-init -c couchbase-data-0-server.{{FRAMEWORK_NAME}}.mesos:8091 --cluster-init-username=Administrator --cluster-init-password={{COUCHBASE_ADMIN_PASSWORD}} --cluster-init-port=8091 --cluster-init-ramsize={{DATA_SERVICE_MEM_USABLE}} {{#INDEX_SERVICE_ENABLED}}--cluster-index-ramsize={{INDEX_SERVICE_MEM_USABLE}} --index-storage-setting={{INDEX_SERVICE_INDEX_TYPE}}{{/INDEX_SERVICE_ENABLED}} --node-init-data-path==$MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/data --node-init-index-path==$MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/index &&
             /opt/couchbase/bin/cbbackupmgr config --archive $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/data/backup --repo cluster 
        resource-set: cli-resources
      rename-seed-host:
        goal: FINISHED
        cmd: >
             curl -vf -X POST -u Administrator:{{COUCHBASE_ADMIN_PASSWORD}} http://couchbase-data-0-server.{{FRAMEWORK_NAME}}.mesos:8091/node/controller/rename -d hostname=couchbase-data-0-server.{{FRAMEWORK_NAME}}.mesos
        resource-set: cli-resources
      rebalance-cluster:
        goal: FINISHED
        cmd: >
            /opt/couchbase/bin/couchbase-cli rebalance -c couchbase-data-0-server.{{FRAMEWORK_NAME}}.mesos:8091 -u Administrator -p {{COUCHBASE_ADMIN_PASSWORD}}
        resource-set: cli-resources
      backup-cluster:
        goal: FINISHED
        cmd: >
             /opt/couchbase/bin/cbbackupmgr backup --archive $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/data/backup --repo cluster --host couchbase://couchbase-data-0-server.{{FRAMEWORK_NAME}}.mesos --username Administrator --password {{COUCHBASE_ADMIN_PASSWORD}}
        resource-set: cli-resources 
      restore-cluster:
        goal: FINISHED
        cmd: >
             /opt/couchbase/bin/cbbackupmgr restore --archive $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/data/backup --repo cluster --host couchbase://couchbase-data-0-server.{{FRAMEWORK_NAME}}.mesos --username Administrator --password {{COUCHBASE_ADMIN_PASSWORD}} --start 2016-03-22T14_00_16.892277632-07_00 --end 2016-03-22T14_00_16.892277632-07_00 --force-updates 
        resource-set: cli-resources                
      add-beer-sample-bucket:
        goal: FINISHED
        cmd: >
          curl -vf -u Administrator:{{COUCHBASE_ADMIN_PASSWORD}} http://couchbase-data-0-server.{{FRAMEWORK_NAME}}.mesos:8091/sampleBuckets/install -X POST -H "Content-Type: application/json" -d '["beer-sample"]'
        resource-set: cli-resources  
      add-travel-sample-bucket:
        goal: FINISHED
        cmd: >
          curl -vf -u Administrator:{{COUCHBASE_ADMIN_PASSWORD}} http://couchbase-data-0-server.{{FRAMEWORK_NAME}}.mesos:8091/sampleBuckets/install -X POST -H "Content-Type: application/json" -d '["travel-sample"]'
        resource-set: cli-resources  
      add-gamesim-sample-bucket:
        goal: FINISHED
        cmd: >
          curl -vf -u Administrator:{{COUCHBASE_ADMIN_PASSWORD}} http://couchbase-data-0-server.{{FRAMEWORK_NAME}}.mesos:8091/sampleBuckets/install -X POST -H "Content-Type: application/json" -d '["gamesim-sample"]'
        resource-set: cli-resources                                                                       
  couchbase_index:
    placement: couchbase-eligible:CLUSTER:true  
    uris: 
      - {{COUCHBASE_INSTALLER_LOCATION}}
    count: {{INDEX_SERVICE_COUNT}}
    resource-sets:
      couchbase-resources:
        cpus: {{INDEX_SERVICE_CPUS}}
        memory: {{INDEX_SERVICE_MEM}}
        volume:
          path: couchbase-container-path
          type: ROOT
          size: {{INDEX_SERVICE_DISK}}
        ports:
          couchbase-web-console:
            port: 8091
          design-doc:
            port: 8092
          query-rest:
            port: 8093
          search-rest:
            port: 8094
          internal-index-admin:
            port: 9100
          internal-index-scan:
            port: 9101
          internal-index-http:
            port: 9102
          internal-index-build:
            port: 9103
          internal-index-build-catchup:
            port: 9104
          internal-index-maintenance:
            port: 9105
          internal-rest:
            port: 9998
          internal-gsi:
            port: 9999
          smart-client-data:
            port: 11207
          internal-bucket:
            port: 11209
          smart-client-memcached:
            port: 11210
          legacy-memcached:
            port: 11211
          xdcr-ssl-1:
            port: 11214
          xdcr-ssl-2:
            port: 11215
          couchbase-web-console-ssl:
            port: 18091
          design-doc-ssl:
            port: 18092
          query-ssl:
            port: 18093
          erlang-port-mapper:
            port: 4369
      cli-resources:
        cpus: 1
        memory: 1024     
    container:
      image-name: centos
      rlimits:
        RLIMIT_NOFILE:
          soft: 40960
          hard: 40960
        RLIMIT_CORE:
          soft: 15728640
          hard: 15728640  
    tasks:
      server:
        goal: RUNNING
        resource-set: couchbase-resources
        cmd: >
          cd $MESOS_SANDBOX/couchbase-container-path &&
          mkdir -p var/lib/couchbase var/lib/couchbase/crash var/lib/couchbase/config var/lib/couchbase/stats var/lib/couchbase/index var/lib/couchbase/logs var/lib/couchbase/data var/lib/moxi &&
          cd .. &&
          yum -y install openssl &&
          rpm -i couchbase-server-enterprise-4.5.1-centos7.x86_64.rpm &&
          chown -R couchbase:couchbase $MESOS_SANDBOX/couchbase-container-path/var &&
          cd /opt/couchbase/var/lib/couchbase &&
          rm -rf config/ stats/ logs/ crash/ data/ &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/config config &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/logs logs &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/stats stats &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/data data &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/index index &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/crash crash &&
          cd .. &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/moxi moxi &&
          /opt/couchbase/bin/couchbase-server -- -noinput
        readiness-check:
          cmd: curl -I localhost:8091/ui/index.html | grep "HTTP/1.1 200 OK"
          interval: 5
          delay: 0
          timeout: 10
      add-index-node:
        goal: FINISHED
        cmd: >
          /opt/couchbase/bin/couchbase-cli server-add -c couchbase-data-0-server.{{FRAMEWORK_NAME}}.mesos:8091 -u Administrator -p {{COUCHBASE_ADMIN_PASSWORD}} --server-add=couchbase-index-$POD_INSTANCE_INDEX-server.{{FRAMEWORK_NAME}}.mesos:8091 --server-add-username=Administrator --server-add-password={{COUCHBASE_ADMIN_PASSWORD}} --services=index
        resource-set: cli-resources  
  couchbase_query:
    placement: couchbase-eligible:CLUSTER:true  
    uris: 
      - {{COUCHBASE_INSTALLER_LOCATION}}
    count: {{QUERY_SERVICE_COUNT}}
    resource-sets:
      couchbase-resources:
        cpus: {{QUERY_SERVICE_CPUS}}
        memory: {{QUERY_SERVICE_MEM}}
        volume:
          path: couchbase-container-path
          type: ROOT
          size: {{QUERY_SERVICE_DISK}}
        ports:
          couchbase-web-console:
            port: 8091
          design-doc:
            port: 8092
          query-rest:
            port: 8093
          search-rest:
            port: 8094
          internal-index-admin:
            port: 9100
          internal-index-scan:
            port: 9101
          internal-index-http:
            port: 9102
          internal-index-build:
            port: 9103
          internal-index-build-catchup:
            port: 9104
          internal-index-maintenance:
            port: 9105
          internal-rest:
            port: 9998
          internal-gsi:
            port: 9999
          smart-client-data:
            port: 11207
          internal-bucket:
            port: 11209
          smart-client-memcached:
            port: 11210
          legacy-memcached:
            port: 11211
          xdcr-ssl-1:
            port: 11214
          xdcr-ssl-2:
            port: 11215
          couchbase-web-console-ssl:
            port: 18091
          design-doc-ssl:
            port: 18092
          query-ssl:
            port: 18093
          erlang-port-mapper:
            port: 4369       
      cli-resources:
        cpus: 1
        memory: 1024     
    container:
      image-name: centos
      rlimits:
        RLIMIT_NOFILE:
          soft: 40960
          hard: 40960
        RLIMIT_CORE:
          soft: 15728640
          hard: 15728640  
    tasks:
      server:
        goal: RUNNING
        resource-set: couchbase-resources
        cmd: >
          cd $MESOS_SANDBOX/couchbase-container-path &&
          mkdir -p var/lib/couchbase var/lib/couchbase/crash var/lib/couchbase/config var/lib/couchbase/stats var/lib/couchbase/index var/lib/couchbase/logs var/lib/couchbase/data var/lib/moxi &&
          cd .. &&
          yum -y install openssl &&
          rpm -i couchbase-server-enterprise-4.5.1-centos7.x86_64.rpm &&
          chown -R couchbase:couchbase $MESOS_SANDBOX/couchbase-container-path/var &&
          cd /opt/couchbase/var/lib/couchbase &&
          rm -rf config/ stats/ logs/ crash/ data/ &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/config config &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/logs logs &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/stats stats &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/data data &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/index index &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/crash crash &&
          cd .. &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/moxi moxi &&
          /opt/couchbase/bin/couchbase-server -- -noinput
        readiness-check:
          cmd: curl -I localhost:8091/ui/index.html | grep "HTTP/1.1 200 OK"
          interval: 5
          delay: 0
          timeout: 10
      add-query-node:
        goal: FINISHED
        cmd: >
          /opt/couchbase/bin/couchbase-cli server-add -c couchbase-data-0-server.{{FRAMEWORK_NAME}}.mesos:8091 -u Administrator -p {{COUCHBASE_ADMIN_PASSWORD}} --server-add=couchbase-query-$POD_INSTANCE_INDEX-server.{{FRAMEWORK_NAME}}.mesos:8091 --server-add-username=Administrator --server-add-password={{COUCHBASE_ADMIN_PASSWORD}} --services=query
        resource-set: cli-resources                                         
plans:
  deploy:
    strategy: serial
    phases:
      setup-data-nodes:
        strategy: serial
        pod: couchbase_data
        steps:
          - 0: [[server], [initialize-cluster], [rename-seed-host]]
          - default: [[server], [add-data-node]]
{{#INDEX_SERVICE_ENABLED}}
      setup-index-nodes:
        strategy: serial
        pod: couchbase_index
        steps:
          - default: [[server], [add-index-node]]
{{/INDEX_SERVICE_ENABLED}}
{{#QUERY_SERVICE_ENABLED}}
      setup-query-nodes:
        strategy: serial
        pod: couchbase_query
        steps:
          - default: [[server], [add-query-node]]
{{/QUERY_SERVICE_ENABLED}}
      rebalance-cluster:
        strategy: serial
        pod: couchbase_data
        steps:
          - 0: [[rebalance-cluster]]
{{#DEMO_DATA_INSTALL_BEER_SAMPLE}}
      load-beer-sample-bucket:
        strategy: serial
        pod: couchbase_data
        steps:
          - 0: [[add-beer-sample-bucket]]
{{/DEMO_DATA_INSTALL_BEER_SAMPLE}}
{{#DEMO_DATA_INSTALL_TRAVEL_SAMPLE}}
      load-travel-sample-bucket:
        strategy: serial
        pod: couchbase_data
        steps:
          - 0: [[add-travel-sample-bucket]]
{{/DEMO_DATA_INSTALL_TRAVEL_SAMPLE}}
{{#DEMO_DATA_INSTALL_GAMESIM_SAMPLE}}
      load-gamesim-sample-bucket:
        strategy: serial
        pod: couchbase_data
        steps:
          - 0: [[add-gamesim-sample-bucket]]
{{/DEMO_DATA_INSTALL_GAMESIM_SAMPLE}}
  backup:
    strategy: serial
    phases:
      backup-cluster:
        strategy: serial
        pod: couchbase_data
        steps:
          - 0: [[backup-cluster]]
  restore:
    strategy: serial
    phases:
      backup-cluster:
        strategy: serial
        pod: couchbase_data
        steps:
          - 0: [[restore-cluster]]          
                    