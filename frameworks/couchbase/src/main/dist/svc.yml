name: {{FRAMEWORK_NAME}}
web-url: http://proxylite-0-server.{{FRAMEWORK_NAME}}.mesos:4040
pods:
  proxylite:
    container:
      image-name: nlsun/proxylite:0.0.13
    count: 1
    tasks:
      server:
        goal: RUNNING
        cmd: "/proxylite/run.sh"
        cpus: 1
        memory: 256
        ports:
          proxylite:
            env-key: PORT_PROXYLITE
            port: 4040
        env:
          ROOT_REDIRECT: "/example"
          EXTERNAL_ROUTES: "/v1,/example,/admin"
          INTERNAL_ROUTES: "{{FRAMEWORK_NAME}}.marathon.mesos:{{PORT0}}/v1,example.com:80,couchbase-seed-0-server.{{FRAMEWORK_NAME}}.mesos:8091"
  couchbase_seed:
    uris: 
      - https://packages.couchbase.com/releases/4.5.1/couchbase-server-enterprise-4.5.1-centos7.x86_64.rpm
      - https://s3-us-west-2.amazonaws.com/jharper-public-mesosphere/samples/beer-sample.zip
    count: {{COUCHBASE_COUNT}}
    resource-sets:
      couchbase-resources:
        cpus: {{COUCHBASE_CPUS}}
        memory: {{COUCHBASE_MEM}}
        volume:
          path: couchbase-container-path
          type: ROOT
          size: {{COUCHBASE_DISK}}
      cli-resources:
        cpus: 1
        memory: 1024     
    container:
      image-name: centos
      rlimits:
        RLIMIT_NOFILE:
          soft: 40960
          hard: 40960
        RLIMIT_CORE:
          soft: 15728640
          hard: 15728640  
    tasks:
      server:
        goal: RUNNING
        resource-set: couchbase-resources
        cmd: >
          cd $MESOS_SANDBOX/couchbase-container-path &&
          mkdir -p var/lib/couchbase var/lib/couchbase/crash var/lib/couchbase/config var/lib/couchbase/stats var/lib/couchbase/index var/lib/couchbase/logs var/lib/couchbase/data var/lib/moxi &&
          cd .. &&
          yum -y install openssl &&
          rpm -i couchbase-server-enterprise-4.5.1-centos7.x86_64.rpm &&
          chown -R couchbase:couchbase $MESOS_SANDBOX/couchbase-container-path/var &&
          cd /opt/couchbase/var/lib/couchbase &&
          rm -rf config/ stats/ logs/ crash/ data/ &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/config config &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/logs logs &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/stats stats &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/data data &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/index index &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/crash crash &&
          cd .. &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/moxi moxi &&
          /opt/couchbase/bin/couchbase-server -- -noinput
        readiness-check:
          cmd: curl -I localhost:8091/ui/index.html | grep "HTTP/1.1 200 OK"
          interval: 5
          delay: 0
          timeout: 10
      initialize-cluster:
        goal: FINISHED
        cmd: >
          /opt/couchbase/bin/couchbase-cli cluster-init -c couchbase-seed-0-server.{{FRAMEWORK_NAME}}.mesos:8091 --cluster-init-username=Administrator --cluster-init-password=password --cluster-init-port=8091 --cluster-init-ramsize=$COUCHBASE_MEM_USABLE --node-init-data-path==$MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/data --node-init-index-path==$MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/index
        resource-set: cli-resources
      rebalance-cluster:
        goal: FINISHED
        cmd: >
          /opt/couchbase/bin/couchbase-cli rebalance -c couchbase-seed-0-server.{{FRAMEWORK_NAME}}.mesos:8091 -u Administrator -p password
        resource-set: cli-resources   
      add-bucket:
        goal: FINISHED
        cmd: >
          /opt/couchbase/bin/couchbase-cli bucket-create -c couchbase-seed-0-server.{{FRAMEWORK_NAME}}.mesos:8091 --bucket=mesosphere --bucket-type=couchbase --bucket-ramsize=100 --bucket-replica=1 -u Administrator -p password
        resource-set: cli-resources  
        readiness-check:
          cmd: /opt/couchbase/bin/couchbase-cli bucket-list -c localhost:8091 -u Administrator -p password | grep mesosphere
          interval: 5
          delay: 0
          timeout: 10              
      create-index:
        goal: FINISHED
        cmd: >
          curl -vf http://couchbase-query-0-server.{{FRAMEWORK_NAME}}.mesos:8093/query/service -d 'statement=CREATE PRIMARY INDEX `mesosphere-primary-index` ON `mesosphere`'
        resource-set: cli-resources  
      load-data:
        goal: FINISHED
        cmd: >
          /opt/couchbase/bin/cbdocloader  -n couchbase-seed-0-server.{{FRAMEWORK_NAME}}.mesos:8091 -u Administrator -p password -b mesosphere $MESOS_SANDBOX/beer-sample.zip
        resource-set: cli-resources        
  couchbase_data:
    uris: 
      - https://packages.couchbase.com/releases/4.5.1/couchbase-server-enterprise-4.5.1-centos7.x86_64.rpm
    count: {{COUCHBASE_COUNT}}
    resource-sets:
      couchbase-resources:
        cpus: {{COUCHBASE_CPUS}}
        memory: {{COUCHBASE_MEM}}
        volume:
          path: couchbase-container-path
          type: ROOT
          size: {{COUCHBASE_DISK}}
      cli-resources:
        cpus: 1
        memory: 1024     
    container:
      image-name: centos
      rlimits:
        RLIMIT_NOFILE:
          soft: 40960
          hard: 40960
        RLIMIT_CORE:
          soft: 15728640
          hard: 15728640  
    tasks:
      server:
        goal: RUNNING
        resource-set: couchbase-resources
        cmd: >
          cd $MESOS_SANDBOX/couchbase-container-path &&
          mkdir -p var/lib/couchbase var/lib/couchbase/crash var/lib/couchbase/config var/lib/couchbase/stats var/lib/couchbase/index var/lib/couchbase/logs var/lib/couchbase/data var/lib/moxi &&
          cd .. &&
          yum -y install openssl &&
          rpm -i couchbase-server-enterprise-4.5.1-centos7.x86_64.rpm &&
          chown -R couchbase:couchbase $MESOS_SANDBOX/couchbase-container-path/var &&
          cd /opt/couchbase/var/lib/couchbase &&
          rm -rf config/ stats/ logs/ crash/ data/ &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/config config &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/logs logs &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/stats stats &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/data data &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/index index &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/crash crash &&
          cd .. &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/moxi moxi &&
          /opt/couchbase/bin/couchbase-server -- -noinput
        readiness-check:
          cmd: curl -I localhost:8091/ui/index.html | grep "HTTP/1.1 200 OK"
          interval: 5
          delay: 0
          timeout: 10
      add-data-node:
        goal: FINISHED
        cmd: >
          /opt/couchbase/bin/couchbase-cli server-add -c couchbase-seed-0-server.{{FRAMEWORK_NAME}}.mesos:8091 -u Administrator -p password --server-add=couchbase-data-$POD_INSTANCE_INDEX-server.{{FRAMEWORK_NAME}}.mesos:8091 --server-add-username=Administrator --server-add-password=password --services=data
        resource-set: cli-resources
  couchbase_index:
    uris: 
      - https://packages.couchbase.com/releases/4.5.1/couchbase-server-enterprise-4.5.1-centos7.x86_64.rpm
    count: {{COUCHBASE_COUNT}}
    resource-sets:
      couchbase-resources:
        cpus: {{COUCHBASE_CPUS}}
        memory: {{COUCHBASE_MEM}}
        volume:
          path: couchbase-container-path
          type: ROOT
          size: {{COUCHBASE_DISK}}
      cli-resources:
        cpus: 1
        memory: 1024     
    container:
      image-name: centos
      rlimits:
        RLIMIT_NOFILE:
          soft: 40960
          hard: 40960
        RLIMIT_CORE:
          soft: 15728640
          hard: 15728640  
    tasks:
      server:
        goal: RUNNING
        resource-set: couchbase-resources
        cmd: >
          cd $MESOS_SANDBOX/couchbase-container-path &&
          mkdir -p var/lib/couchbase var/lib/couchbase/crash var/lib/couchbase/config var/lib/couchbase/stats var/lib/couchbase/index var/lib/couchbase/logs var/lib/couchbase/data var/lib/moxi &&
          cd .. &&
          yum -y install openssl &&
          rpm -i couchbase-server-enterprise-4.5.1-centos7.x86_64.rpm &&
          chown -R couchbase:couchbase $MESOS_SANDBOX/couchbase-container-path/var &&
          cd /opt/couchbase/var/lib/couchbase &&
          rm -rf config/ stats/ logs/ crash/ data/ &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/config config &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/logs logs &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/stats stats &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/data data &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/index index &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/crash crash &&
          cd .. &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/moxi moxi &&
          /opt/couchbase/bin/couchbase-server -- -noinput
        readiness-check:
          cmd: curl -I localhost:8091/ui/index.html | grep "HTTP/1.1 200 OK"
          interval: 5
          delay: 0
          timeout: 10
      add-index-node:
        goal: FINISHED
        cmd: >
          /opt/couchbase/bin/couchbase-cli server-add -c couchbase-seed-0-server.{{FRAMEWORK_NAME}}.mesos:8091 -u Administrator -p password --server-add=couchbase-index-$POD_INSTANCE_INDEX-server.{{FRAMEWORK_NAME}}.mesos:8091 --server-add-username=Administrator --server-add-password=password --services=index
        resource-set: cli-resources  
  couchbase_query:
    uris: 
      - https://packages.couchbase.com/releases/4.5.1/couchbase-server-enterprise-4.5.1-centos7.x86_64.rpm
    count: {{COUCHBASE_COUNT}}
    resource-sets:
      couchbase-resources:
        cpus: {{COUCHBASE_CPUS}}
        memory: {{COUCHBASE_MEM}}
        volume:
          path: couchbase-container-path
          type: ROOT
          size: {{COUCHBASE_DISK}}
      cli-resources:
        cpus: 1
        memory: 1024     
    container:
      image-name: centos
      rlimits:
        RLIMIT_NOFILE:
          soft: 40960
          hard: 40960
        RLIMIT_CORE:
          soft: 15728640
          hard: 15728640  
    tasks:
      server:
        goal: RUNNING
        resource-set: couchbase-resources
        cmd: >
          cd $MESOS_SANDBOX/couchbase-container-path &&
          mkdir -p var/lib/couchbase var/lib/couchbase/crash var/lib/couchbase/config var/lib/couchbase/stats var/lib/couchbase/index var/lib/couchbase/logs var/lib/couchbase/data var/lib/moxi &&
          cd .. &&
          yum -y install openssl &&
          rpm -i couchbase-server-enterprise-4.5.1-centos7.x86_64.rpm &&
          chown -R couchbase:couchbase $MESOS_SANDBOX/couchbase-container-path/var &&
          cd /opt/couchbase/var/lib/couchbase &&
          rm -rf config/ stats/ logs/ crash/ data/ &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/config config &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/logs logs &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/stats stats &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/data data &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/index index &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/couchbase/crash crash &&
          cd .. &&
          ln -s $MESOS_SANDBOX/couchbase-container-path/var/lib/moxi moxi &&
          /opt/couchbase/bin/couchbase-server -- -noinput
        readiness-check:
          cmd: curl -I localhost:8091/ui/index.html | grep "HTTP/1.1 200 OK"
          interval: 5
          delay: 0
          timeout: 10
      add-query-node:
        goal: FINISHED
        cmd: >
          /opt/couchbase/bin/couchbase-cli server-add -c couchbase-seed-0-server.{{FRAMEWORK_NAME}}.mesos:8091 -u Administrator -p password --server-add=couchbase-query-$POD_INSTANCE_INDEX-server.{{FRAMEWORK_NAME}}.mesos:8091 --server-add-username=Administrator --server-add-password=password --services=query
        resource-set: cli-resources                                         
plans:
  deploy:
    strategy: serial
    phases:
      initialize-cluster:
        strategy: serial
        pod: couchbase_seed
        steps:
          - default: [[server], [initialize-cluster]]
      setup-data-nodes:
        strategy: serial
        pod: couchbase_data
        steps:
          - default: [[server], [add-data-node]]
      setup-index-nodes:
        strategy: serial
        pod: couchbase_index
        steps:
          - default: [[server], [add-index-node]]
      setup-query-nodes:
        strategy: serial
        pod: couchbase_query
        steps:
          - default: [[server], [add-query-node]]                    
      rebalance-cluster:
        strategy: serial
        pod: couchbase_seed
        steps:
          - default: [[rebalance-cluster]]      
      setup-proxy:
        strategy: serial
        pod: proxylite
        steps:
          - default: [[server]]
      create-sample-bucket:
        strategy: serial
        pod: couchbase_seed
        steps:
          - default: [[add-bucket],[create-index],[load-data]]                                    
                    