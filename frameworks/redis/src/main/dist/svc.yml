name: {{FRAMEWORK_NAME}}
web-url: http://proxylite-0-server.{{FRAMEWORK_NAME}}.mesos:4040
scheduler:
  principal: {{FRAMEWORK_PRINCIPAL}}
  user: {{FRAMEWORK_USER}}
pods:
  redis:
    count: {{REDIS_COUNT}}
    container:
      image-name: nickbp/redis-test
      rlimits:
        RLIMIT_SIGPENDING:
          soft: 483022
          hard: 483022
        RLIMIT_NPROC:
          soft: 483022
          hard: 483022
    tasks:
      server:
        goal: RUNNING
        #&& echo PDNS CONFIG
        #&& mkdir -p /opt/etc/redislabs/pdns.conf.d/
        #&& echo "local-address=$(echo $MESOS_AGENT_ENDPOINT | cut -d : -f 1)" > /opt/etc/redislabs/pdns.conf.d/fixed-ip.conf
        #&& ls -l /opt/etc/redislabs/pdns.conf.d/
        #&& cat /opt/etc/redislabs/pdns.conf.d/*
        cmd: >
          ps aux
          && env
          && echo SUPERVISORD CONFIG
          && sed -i 's,command=.*/pdns_server,command=sleep infinity,g' /opt/redislabs/config/supervisord.conf
          && cat /opt/redislabs/config/supervisord.conf
          && echo START
          && /opt/start.sh
        cpus: {{REDIS_CPUS}}
        memory: {{REDIS_MEM}}
        ports:
          web:
            port: 8443
          bigrange:
            min: 10000
            max: 10100
        volume:
          path: "redis-volume"
          type: ROOT
          size: {{REDIS_DISK}}
        env:
          SLEEP_DURATION: {{SLEEP_DURATION}}
  proxylite:
    container:
      image-name: mesosphere/proxylite:1.0.1
    count: 1
    uris:
      - {{BOOTSTRAP_URI}}
    tasks:
      server:
        goal: RUNNING
        cmd: "./bootstrap -resolve-hosts=redis-0-server.{{FRAMEWORK_NAME}}.mesos && /proxylite/run.sh"
        cpus: 0.1
        memory: 100
        ports:
          proxylite:
            env-key: PORT_PROXYLITE
            port: 4040
        env:
          ROOT_REDIRECT: "/ui"
          EXTERNAL_ROUTES: "/v1,/ui"
          INTERNAL_ROUTES: "{{FRAMEWORK_NAME}}.marathon.mesos:{{PORT0}}/v1,redis-0-server.{{FRAMEWORK_NAME}}.mesos:8443"
