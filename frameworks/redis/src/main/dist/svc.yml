name: {{FRAMEWORK_NAME}}
web-url: http://proxylite-0-server.{{FRAMEWORK_NAME}}.mesos:4040
scheduler:
  principal: {{FRAMEWORK_PRINCIPAL}}
  user: {{FRAMEWORK_USER}}
pods:
  redis:
    user: root # to bind to port 53 (possibly other things?) -- note: doesn't seem to help with binding to 53
    count: {{REDIS_COUNT}}
    placement: {{PLACEMENT_CONSTRAINTS}}
    container:
      image-name: nickbp/redis-test:1
      rlimits:
        RLIMIT_SIGPENDING:
          soft: 483022
          hard: 483022
        RLIMIT_NPROC:
          soft: 483022
          hard: 483022
        RLIMIT_NOFILE:
          soft: 100000
          hard: 100000
        RLIMIT_CORE:
          soft:
          hard:
    uris:
      - {{BOOTSTRAP_URI}}
    tasks:
      server:
        goal: RUNNING
        #&& echo SUPERVISORD CONFIG
        #&& sed -i 's,command=.*/pdns_server,command=sleep infinity,g' /opt/redislabs/config/supervisord.conf
        #&& cat /opt/redislabs/config/supervisord.conf
        cmd: >
          ${MESOS_SANDBOX}/bootstrap
          && rsyslogd -i ${MESOS_SANDBOX}/rsyslogd.pid
          && ls -l /dev/
          && ps aux
          && echo USER $(whoami)
          && MESOS_IP=$(sh ${MESOS_SANDBOX}/get-ip.sh)
          && echo IP $MESOS_IP
          && echo PDNS CONFIG
          && mkdir -p /etc/opt/redislabs/pdns.conf.d/
          && echo "local-address=${MESOS_IP}" > /etc/opt/redislabs/pdns.conf.d/fixed-ip.conf
          && echo "local-port=5354" >> /etc/opt/redislabs/pdns.conf.d/fixed-ip.conf
          && ls -l /etc/opt/redislabs/pdns.conf.d/
          && cat /etc/opt/redislabs/pdns.conf.d/*
          && echo START
          && /opt/start.sh
        cpus: {{REDIS_CPUS}}
        memory: {{REDIS_MEM}}
        ports:
          # doc: https://redislabs.com/redis-enterprise-documentation/cluster-administration/best-practices/machine-ports-configuration/
          internal1:
            port-min: 3333
            port-max: 3337
          #internal2: (TODO these ports are not offered by mesos - set to other value in redis?)
          #  port-min: 36379
          #  port-max: 36380
          dns1:
            port: 5354 # TODO this would normally be port 53, which isn't offered by mesos anyway. see pdns config in command
          dns2:
            port: 5353
          web-ssl:
            port: 8443
          #rest: (TODO this port is not offered by mesos - set to other value in redis?)
          #  port: 8080
          rest-ssl:
            port: 9443
          db-external:
            port-min: {{PORT_EXTERNAL_MIN}}
            port-max: {{PORT_EXTERNAL_MAX}}
          db-internal:
            port-min: {{PORT_INTERNAL_MIN}}
            port-max: {{PORT_INTERNAL_MAX}}
        volume:
          path: "redis-volume"
          type: ROOT
          size: {{REDIS_DISK}}
        configs:
          sample.conf:
            template: {{CONFIG_TEMPLATE_PATH}}/sample.conf.tmpl
            dest: /mnt/mesos/sandbox/sample.conf
          get-ip.sh:
            template: {{CONFIG_TEMPLATE_PATH}}/get-ip.sh.tmpl
            dest: /mnt/mesos/sandbox/get-ip.sh
        env:
          PORT_EXTERNAL_MIN: {{PORT_EXTERNAL_MIN}}
          PORT_EXTERNAL_MAX: {{PORT_EXTERNAL_MAX}}
          PORT_INTERNAL_MIN: {{PORT_INTERNAL_MIN}}
          PORT_INTERNAL_MAX: {{PORT_INTERNAL_MAX}}
  proxylite:
    container:
      image-name: mesosphere/proxylite:2.0.0
    count: 1
    uris:
      - {{BOOTSTRAP_URI}}
    tasks:
      server:
        goal: RUNNING
        cmd: "./bootstrap -resolve-hosts=redis-0-server.{{FRAMEWORK_NAME}}.mesos,redis-1-server.{{FRAMEWORK_NAME}}.mesos,redis-2-server.{{FRAMEWORK_NAME}}.mesos && /proxylite/run.sh"
        cpus: 0.1
        memory: 100
        ports:
          proxylite:
            env-key: PORT_PROXYLITE
            port: 4040
        env:
          ROOT_REDIRECT: "/ui0/"
          EXTERNAL_ROUTES: "/v1,/ui0,/api0,/ui1,/api1,/ui2,/api2"
          INTERNAL_ROUTES: "http://{{FRAMEWORK_NAME}}.marathon.mesos:{{PORT0}}/v1,https://redis-0-server.{{FRAMEWORK_NAME}}.mesos:8443,https://redis-0-server.{{FRAMEWORK_NAME}}.mesos:9443,https://redis-1-server.{{FRAMEWORK_NAME}}.mesos:8443,https://redis-1-server.{{FRAMEWORK_NAME}}.mesos:9443,https://redis-2-server.{{FRAMEWORK_NAME}}.mesos:8443,https://redis-2-server.{{FRAMEWORK_NAME}}.mesos:9443"
