name: {{FRAMEWORK_NAME}}
web-url: http://proxylite-0-server.{{FRAMEWORK_NAME}}.mesos:4040
scheduler:
  principal: {{FRAMEWORK_PRINCIPAL}}
  user: {{FRAMEWORK_USER}}
pods:
  redis:
    count: {{REDIS_COUNT}}
    container:
      image-name: nickbp/redis-test
      rlimits:
        RLIMIT_SIGPENDING:
          soft: 483022
          hard: 483022
        RLIMIT_NPROC:
          soft: 483022
          hard: 483022
    uris:
      - {{BOOTSTRAP_URI}}
    tasks:
      server:
        goal: RUNNING
        cmd: >
          ./bootstrap
          && echo IP $(sh get-ip.sh)
          && echo SUPERVISORD CONFIG
          && sed -i 's,command=.*/pdns_server,command=sleep infinity,g' /opt/redislabs/config/supervisord.conf
          && cat /opt/redislabs/config/supervisord.conf
          && echo START
          && /opt/start.sh
        cpus: {{REDIS_CPUS}}
        memory: {{REDIS_MEM}}
        ports:
          # doc: https://redislabs.com/redis-enterprise-documentation/cluster-administration/best-practices/machine-ports-configuration/
          internal1:
            port-min: 3333
            port-max: 3337
          internal2:
            port-min: 36379
            port-max: 36380
          #dns1:
          #  port: 53
          dns2:
            port: 5353
          web-ssl:
            port: 8443
          rest:
            port: 8080
          rest-ssl:
            port: 9443
          db-external:
            port-min: {{PORT_EXTERNAL_MIN}}
            port-max: {{PORT_EXTERNAL_MAX}}
          db-internal:
            port-min: {{PORT_INTERNAL_MIN}}
            port-max: {{PORT_INTERNAL_MAX}}
        volume:
          path: "redis-volume"
          type: ROOT
          size: {{REDIS_DISK}}
        configs:
          sample.conf:
            template: {{CONFIG_TEMPLATE_PATH}}/sample.conf.tmpl
            dest: sample.conf
          get-ip.sh:
            template: {{CONFIG_TEMPLATE_PATH}}/get-ip.sh.tmpl
            dest: get-ip.sh
        env:
          PORT_EXTERNAL_MIN: {{PORT_EXTERNAL_MIN}}
          PORT_EXTERNAL_MAX: {{PORT_EXTERNAL_MAX}}
          PORT_INTERNAL_MIN: {{PORT_INTERNAL_MIN}}
          PORT_INTERNAL_MAX: {{PORT_INTERNAL_MAX}}
  proxylite:
    container:
      image-name: mesosphere/proxylite:1.0.1
    count: 1
    uris:
      - {{BOOTSTRAP_URI}}
    tasks:
      server:
        goal: RUNNING
        cmd: "./bootstrap -resolve-hosts=redis-0-server.{{FRAMEWORK_NAME}}.mesos && /proxylite/run.sh"
        cpus: 0.1
        memory: 100
        ports:
          proxylite:
            env-key: PORT_PROXYLITE
            port: 4040
        env:
          ROOT_REDIRECT: "/ui"
          EXTERNAL_ROUTES: "/v1,/ui"
          INTERNAL_ROUTES: "{{FRAMEWORK_NAME}}.marathon.mesos:{{PORT0}}/v1,redis-0-server.{{FRAMEWORK_NAME}}.mesos:8443"
