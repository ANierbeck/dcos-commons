name: {{FRAMEWORK_NAME}}
web-url: http://proxylite-0-server.{{FRAMEWORK_NAME}}.mesos:4040
pods:
  cockroach:
    count: {{COCKROACH_COUNT}}
    uris:
      - {{COCKROACH_URI}}
    resource-sets:
      db-resources:
        cpus: {{COCKROACH_CPUS}}
        memory: {{COCKROACH_MEM}}
        ports:
          db-port:
            port: 26257
            env-key: DB_PORT
          http-port:
            port: 26258
            env-key: HTTP_PORT
        volume:
          path: cockroach-data
          size: {{COCKROACH_DISK}}
          type: ROOT
    tasks:
      bootstrap:
        goal: RUNNING
        resource-set: db-resources
        cmd: >
               ./cockroach-beta-20170209.linux-amd64/cockroach start
               --insecure
               --store=cockroach-data
               --port=$DB_PORT
               --http-port=$HTTP_PORT
               --logtostderr
               --no-color
      server:
        goal: RUNNING
        resource-set: db-resources
        cmd: >
               ./cockroach-beta-20170209.linux-amd64/cockroach start
               --insecure
               --store=cockroach-data
               --port=$DB_PORT
               --http-port=$HTTP_PORT
               --logtostderr
               --no-color
               --join=cockroach-0-bootstrap.{{FRAMEWORK_NAME}}.mesos:26257
  proxylite:
    container:
      # The image here is built and pushed
      image-name: mesosphere/proxylite:1.0.0
    count: 1
    tasks:
      server:
        goal: RUNNING
        cmd: "/proxylite/run.sh"
        cpus: {{PROXYLITE_CPUS}}
        memory: {{PROXYLITE_MEM}}
        ports:
          proxylite:
            env-key: PORT_PROXYLITE
            port: 4040
        env:
          ROOT_REDIRECT: /admin
          EXTERNAL_ROUTES: /v1,/admin
          INTERNAL_ROUTES: {{FRAMEWORK_NAME}}.marathon.mesos:{{PORT0}}/v1,cockroach-0-bootstrap.{{FRAMEWORK_NAME}}.mesos:26258
plans:
  deploy:
    strategy: parallel
    phases:
      db:
        strategy: serial
        pod: cockroach
        steps:
          - 0: [[bootstrap]]
          - default: [[server]]
      proxy:
        strategy: serial
        pod: cockroach
        steps:
          - default: [[server]]
